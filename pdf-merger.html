<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PDF & Image Merger by Istinub Azad</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body{
  font-family:"Inter",sans-serif;
  background:
    linear-gradient(rgba(255,255,255,.9),rgba(255,255,255,.9)),
    url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1600&q=80');
  background-size:cover;background-position:center;background-attachment:fixed;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;margin:0;padding:24px 12px;
}
header{text-align:center;margin-bottom:16px;}
header h1{margin:0;font-size:28px;color:#222;text-shadow:0 1px 2px rgba(0,0,0,.15);}
header p{margin-top:6px;font-size:15px;color:#555;}
.card{
  background:rgba(255,255,255,.96);
  border-radius:14px;box-shadow:0 8px 25px rgba(0,0,0,.08);
  padding:24px;width:100%;max-width:980px;text-align:center;backdrop-filter:blur(8px);
}
.drop-zone{
  position:relative;border:2px dashed #c6c9d1;border-radius:10px;padding:26px;
  color:#555;background:#fafafa;transition:all .25s;cursor:pointer;margin-bottom:18px;
}
.drop-zone:hover,.drop-zone.dragover{border-color:#007bff;background:#eef5ff;}
.drop-zone input{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;}
.grid{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-bottom:18px;}
.file-card{width:180px;background:#f9fafb;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,.05);
  padding:10px;display:flex;flex-direction:column;align-items:center;cursor:grab;transition:transform .15s;}
.file-card.dragging{opacity:.55;transform:scale(.97);}
.file-card.drag-over{outline:2px dashed #007bff;}
.file-card canvas{border:1px solid #ddd;border-radius:6px;width:100%;height:210px;object-fit:cover;}
.file-name{margin-top:8px;font-size:13px;color:#333;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
.actions{display:flex;gap:6px;margin-top:6px;}
.actions button{border:none;border-radius:5px;padding:4px 6px;font-size:12px;cursor:pointer;
  background:#e9ecef;color:#333;transition:background .2s;}
.actions button:hover{background:#d7dbe0;}
.delete-btn{background:#fdecec;color:#d00;}
.delete-btn:hover{background:#fbd6d6;}
#mergeBtn{background:#007bff;color:#fff;border:none;border-radius:6px;padding:10px 20px;
  font-size:16px;cursor:pointer;transition:background .2s,transform .1s;}
#mergeBtn:hover{background:#0056b3;transform:scale(1.03);}
.status{margin-top:12px;color:#555;font-size:14px;}
footer{text-align:center;margin-top:18px;font-size:13px;color:#555;}
footer a{color:#007bff;font-weight:600;text-decoration:none;}
footer a:hover{text-decoration:underline;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999;}
.modal.open{display:flex;}
.modal-content{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);
  width:min(1000px,96vw);max-height:92vh;display:flex;flex-direction:column;}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee;gap:10px;flex-wrap:wrap;}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.canvas-wrap{padding:12px;overflow:auto;display:flex;justify-content:center;align-items:center;background:#f7f8fa;}
#fullCanvas{background:#fff;border:1px solid #e5e7eb;border-radius:8px;max-width:100%;}
.thumb-strip{display:flex;overflow-x:auto;gap:6px;padding:8px 10px;background:#fafafa;border-top:1px solid #eee;}
.thumb-strip canvas{border:1px solid #ccc;border-radius:4px;height:84px;cursor:pointer;}
.thumb-strip canvas:hover{transform:scale(1.08);border-color:#007bff;}
.modal-footer{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-top:1px solid #eee;font-size:13px;color:#555;}
/* Compression Modal */
#compressionModal .modal-content{
  width:300px;text-align:center;padding:20px;gap:12px;display:flex;flex-direction:column;
}
#compressionModal button{
  border:none;border-radius:6px;padding:8px;font-size:15px;cursor:pointer;
  background:#007bff;color:white;transition:background .2s;
}
#compressionModal button:hover{background:#0056b3;}
.hidden{display:none;}
@media(max-width:560px){.file-card{width:45%;}}
</style>
</head>
<body>

<header>
  <h1>PDF & Image Merger</h1>
  <p>A simple but handy app for daily use</p>
</header>

<div class="card">
  <div class="drop-zone" id="dropZone">
    <p>üìÇ <strong>Click</strong> or <strong>Drag & Drop</strong> PDFs or Images here</p>
    <input type="file" id="fileInput" multiple accept="application/pdf,image/*">
  </div>

  <div class="grid" id="fileGrid"></div>

  <button id="mergeBtn">Merge Files (in shown order)</button>
  <div class="status" id="statusMsg"></div>
</div>

<footer>
  Created by <a href="https://istinubazad.github.io/" target="_blank">Istinub Azad</a>
</footer>

<!-- Preview Modal -->
<div class="modal" id="previewModal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Preview</div>
      <div class="modal-actions">
        <span id="pageInfo">Page 1 / 1</span>
        <button id="rotateLeft">‚Ü©Ô∏è</button>
        <button id="rotateRight">‚Ü™Ô∏è</button>
        <button id="resetRot">üîÅ Reset</button>
        <button class="close-btn" id="closeModal">‚úñ</button>
      </div>
    </div>
    <div class="canvas-wrap"><canvas id="fullCanvas"></canvas></div>
    <div class="modal-footer"><div id="fileInfo"></div></div>
  </div>
</div>

<!-- Compression Modal -->
<div class="modal" id="compressionModal">
  <div class="modal-content">
    <h3>Select Compression Level</h3>
    <button onclick="confirmCompression('none')">No Compression (Original Quality)</button>
    <button onclick="confirmCompression('high')">High (Smaller file)</button>
    <button onclick="confirmCompression('medium')">Medium (Balanced)</button>
    <button onclick="confirmCompression('low')">Low (Best quality)</button>
  </div>
</div> 


<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
const { PDFDocument, degrees } = PDFLib;
let selectedFiles=[];

const dropZone=document.getElementById("dropZone"),
fileInput=document.getElementById("fileInput"),
fileGrid=document.getElementById("fileGrid"),
statusMsg=document.getElementById("statusMsg"),
mergeBtn=document.getElementById("mergeBtn");

/* Modal */
const modal=document.getElementById("previewModal"),
modalTitle=document.getElementById("modalTitle"),
fullCanvas=document.getElementById("fullCanvas"),
ctx=fullCanvas.getContext("2d"),
btnRotL=document.getElementById("rotateLeft"),
btnRotR=document.getElementById("rotateRight"),
btnReset=document.getElementById("resetRot"),
btnClose=document.getElementById("closeModal"),
fileInfo=document.getElementById("fileInfo");
let currentFileIndex=null,currentRotation=0;

/* Upload handlers */
fileInput.onchange=e=>{addFiles([...e.target.files]);fileInput.value="";};
dropZone.ondragover=e=>{e.preventDefault();dropZone.classList.add("dragover");};
dropZone.ondragleave=()=>dropZone.classList.remove("dragover");
dropZone.ondrop=e=>{e.preventDefault();dropZone.classList.remove("dragover");addFiles([...e.dataTransfer.files]);};

function addFiles(files){
  files.forEach(f=>{
    if(f.type==="application/pdf"||f.type.startsWith("image/")){
      selectedFiles.push({file:f,rotations:{},type:f.type});
    }
  });
  renderGrid();
}

/* Render grid cards */
async function renderGrid(){
  fileGrid.innerHTML="";
  for(let i=0;i<selectedFiles.length;i++){
    const it=selectedFiles[i];
    const card=document.createElement("div");
    card.className="file-card";
    card.draggable=true;
    card.dataset.index=i;
    const canvas=document.createElement("canvas");
    const name=document.createElement("div");
    name.className="file-name";
    name.textContent=`${i+1}. ${it.file.name}`;
    const actions=document.createElement("div");
    actions.className="actions";
    actions.innerHTML=`<button onclick="openPreview(${i})">üëÅ Preview</button><button class="delete-btn" onclick="removeFile(${i})">üóë</button>`;
    card.append(canvas,name,actions);
    fileGrid.appendChild(card);
    card.addEventListener("dragstart",dragStart);
    card.addEventListener("dragover",dragOver);
    card.addEventListener("dragleave",dragLeave);
    card.addEventListener("drop",dropCard);
    card.addEventListener("dragend",dragEnd);
    if(it.type==="application/pdf"){
      try{
        const ab=await it.file.arrayBuffer();
        const pdf=await pdfjsLib.getDocument({data:ab}).promise;
        const page=await pdf.getPage(1);
        const vp=page.getViewport({scale:.4});
        const ctx2=canvas.getContext("2d");
        canvas.width=vp.width;canvas.height=vp.height;
        await page.render({canvasContext:ctx2,viewport:vp}).promise;
      }catch(e){console.error(e);}
    }else{ // image
      const img=new Image();
      img.onload=()=>{
        const scale=180/img.width;
        canvas.width=img.width*scale;
        canvas.height=img.height*scale;
        canvas.getContext("2d").drawImage(img,0,0,canvas.width,canvas.height);
      };
      img.src=URL.createObjectURL(it.file);
    }
  }
}
window.removeFile=i=>{selectedFiles.splice(i,1);renderGrid();};

/* Reorder drag */
let dragSrc=null;
function dragStart(e){dragSrc=this;this.classList.add("dragging");}
function dragOver(e){e.preventDefault();this.classList.add("drag-over");}
function dragLeave(){this.classList.remove("drag-over");}
function dropCard(e){
  e.stopPropagation();this.classList.remove("drag-over");
  const s=parseInt(dragSrc.dataset.index),t=parseInt(this.dataset.index);
  if(s!==t){const m=selectedFiles.splice(s,1)[0];selectedFiles.splice(t,0,m);renderGrid();}
}
function dragEnd(){this.classList.remove("dragging");}

/* Preview modal */
window.openPreview=async(i)=>{
  currentFileIndex=i;const it=selectedFiles[i];
  modalTitle.textContent=it.file.name;
  currentRotation=it.rotations[0]||0;
  modal.classList.add("open");modal.setAttribute("aria-hidden","false");
  if(it.type==="application/pdf"){
    const ab=await it.file.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    const page=await pdf.getPage(1);const vp=page.getViewport({scale:1,rotation:currentRotation});
    fullCanvas.width=vp.width;fullCanvas.height=vp.height;
    await page.render({canvasContext:ctx,viewport:vp}).promise;
  }else{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(800/img.width,1);
      fullCanvas.width=img.width*scale;fullCanvas.height=img.height*scale;
      const cctx=fullCanvas.getContext("2d");
      cctx.save();
      cctx.translate(fullCanvas.width/2,fullCanvas.height/2);
      cctx.rotate(currentRotation*Math.PI/180);
      cctx.drawImage(img,-img.width*scale/2,-img.height*scale/2,img.width*scale,img.height*scale);
      cctx.restore();
    };
    img.src=URL.createObjectURL(it.file);
  }
  fileInfo.textContent=`Rotation: ${currentRotation}¬∞`;
};
function closePreview(){modal.classList.remove("open");modal.setAttribute("aria-hidden","true");}

/* Rotation controls */
btnRotL.onclick=()=>{updateRotation(-90);};
btnRotR.onclick=()=>{updateRotation(90);};
btnReset.onclick=()=>{updateRotation(0,true);};
btnClose.onclick=()=>{closePreview();updateThumb(currentFileIndex);};

function updateRotation(delta,reset=false){
  const it=selectedFiles[currentFileIndex];
  if(reset)currentRotation=0;else currentRotation=(currentRotation+delta+360)%360;
  it.rotations[0]=currentRotation;
  openPreview(currentFileIndex);
}

/* Update thumbnail when closing */
async function updateThumb(idx){
  const it=selectedFiles[idx];
  const card=fileGrid.querySelector(`.file-card[data-index="${idx}"]`);
  if(!card)return;
  const canvas=card.querySelector("canvas");
  if(it.type==="application/pdf"){
    try{
      const ab=await it.file.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:ab}).promise;
      const page=await pdf.getPage(1);
      const vp=page.getViewport({scale:.4,rotation:it.rotations[0]||0});
      canvas.width=vp.width;canvas.height=vp.height;
      await page.render({canvasContext:canvas.getContext("2d"),viewport:vp}).promise;
    }catch(e){console.error(e);}
  }else{
    const img=new Image();
    img.onload=()=>{
      const scale=180/img.width;
      canvas.width=img.width*scale;canvas.height=img.height*scale;
      const cctx=canvas.getContext("2d");
      cctx.save();
      cctx.translate(canvas.width/2,canvas.height/2);
      cctx.rotate((it.rotations[0]||0)*Math.PI/180);
      cctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
      cctx.restore();
    };
    img.src=URL.createObjectURL(it.file);
  }
}

/* --- Build merged PDF (keeps previous behavior, no download here) --- */
async function buildMergedPDFBlob(){
  const merged=await PDFDocument.create();

  for(const it of selectedFiles){
    if(it.type==="application/pdf"){
      const bytes=await it.file.arrayBuffer();
      const src=await PDFDocument.load(bytes);
      const pages=await merged.copyPages(src, src.getPageIndices());
      pages.forEach((p, i)=>{
        const r=it.rotations[i]||it.rotations[0]||0;
        if(r) p.setRotation(degrees(r));
        merged.addPage(p);
      });
    }else{
      const imgBytes=await it.file.arrayBuffer();
      let imgEmbed;
      if(it.type==="image/png") imgEmbed=await merged.embedPng(imgBytes);
      else imgEmbed=await merged.embedJpg(imgBytes);
      const angle=it.rotations[0]||0;
      const { width, height } = imgEmbed;
      const page=merged.addPage([width, height]);
      page.drawImage(imgEmbed,{ x:0,y:0,width,height, rotate: degrees(angle) });
    }
  }

  const mergedBytes=await merged.save();
  return new Blob([mergedBytes],{type:"application/pdf"});
}

/* --- Compression Logic --- */
async function compressPDF(pdfBlob, level='medium'){
  const arrayBuffer=await pdfBlob.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  const compressedPdf=await PDFLib.PDFDocument.create();

  const canvas=document.createElement("canvas");
  const cctx=canvas.getContext("2d");

  // Quality map
  let quality=0.75;
  if(level==='high') quality=0.5;
  else if(level==='low') quality=0.9;

  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1.0});
    canvas.width=vp.width;canvas.height=vp.height;

    await page.render({canvasContext:cctx,viewport:vp}).promise;

    const imgData=canvas.toDataURL('image/jpeg', quality);
    const imgBytes=await fetch(imgData).then(r=>r.arrayBuffer());
    const img=await compressedPdf.embedJpg(imgBytes);

    const newPage=compressedPdf.addPage([vp.width, vp.height]);
    newPage.drawImage(img,{x:0,y:0,width:vp.width,height:vp.height});

    cctx.clearRect(0,0,canvas.width,canvas.height);
  }

  const compressedBytes=await compressedPdf.save();
  return new Blob([compressedBytes],{type:"application/pdf"});
}

/* Compression Modal handlers */
function askCompressionLevel(){
  return new Promise((resolve)=>{
    const modal=document.getElementById('compressionModal');
    modal.classList.add('open');
    window.confirmCompression=(lvl)=>{
      modal.classList.remove('open');
      resolve(lvl);
    };
  });
}

/* Merge + Ask Compression + Download */
mergeBtn.onclick = async () => {
  if (selectedFiles.length < 1) {
    statusMsg.textContent = "Please select at least one file.";
    return;
  }

  statusMsg.textContent = "Merging...";
  try {
    const mergedBlob = await buildMergedPDFBlob();
    statusMsg.textContent = "Choose compression level...";
    const level = await askCompressionLevel();

    let finalBlob;

    if (level === 'none') {
      // Direct download (no compression)
      finalBlob = mergedBlob;
    } else {
      statusMsg.textContent = "Compressing...";
      finalBlob = await compressPDF(mergedBlob, level);
    }

    const a = document.createElement("a");
    a.href = URL.createObjectURL(finalBlob);
    a.download = (level === 'none') ? "merged_original.pdf" : "merged_compressed.pdf";
    a.click();
    statusMsg.textContent = "‚úÖ File ready for download!";
  } catch (e) {
    console.error(e);
    statusMsg.textContent = "‚ùå Merge/compress failed.";
  }
};

</script>
</body>
</html>
